cmake_minimum_required (VERSION 3.7)
project(chirp Fortran)
enable_testing()

if(CMAKE_BUILD_TYPE STREQUAL Debug)
  add_compile_options(-g -O0)
else()
  add_compile_options(-O3)
endif()

if(${CMAKE_Fortran_COMPILER_ID} STREQUAL Intel)
  set(FFLAGS -check all -traceback -warn -debug extended)
elseif(${CMAKE_Fortran_COMPILER_ID} STREQUAL GNU)
  if(${CMAKE_Fortran_COMPILER_VERSION} VERSION_GREATER_EQUAL 8.1)
    set(FFLAGS -std=f2018)
  else()
    set(FFLAGS -std=f2008ts)
  endif()
  list(APPEND FFLAGS -march=native -Wall -Wextra -Wpedantic -Werror=array-bounds -fbacktrace -fcheck=all)
elseif(${CMAKE_Fortran_COMPILER_ID} STREQUAL PGI)
  set(FFLAGS -Mallocatable=03)
elseif(${CMAKE_Fortran_COMPILER_ID} STREQUAL Flang) 
  add_compile_options(-Mallocatable=03)
  link_libraries(-static-flang-libs)
endif()
#------------
add_library(fwdmodel fwdmodel.f90 comm.f90)
target_compile_options(fwdmodel PRIVATE ${FFLAGS})

add_executable(chirp test_chirp.f90)
target_compile_options(chirp PRIVATE ${FFLAGS})
target_link_libraries(chirp PRIVATE fwdmodel)
add_test(NAME FortranChirp COMMAND chirp)
set_tests_properties(FortranChirp PROPERTIES TIMEOUT 10)

